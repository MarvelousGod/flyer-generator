<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flyer Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
    </style>
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-lg bg-white rounded-xl shadow-lg p-6 md:p-8">
      <div class="text-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">
          CHGEC YOUTH CONVENTION FLYER GENERATOR
        </h1>
        <p class="text-gray-500 mt-2">
          Upload your photo and enter your name to generate your custom flyer.
        </p>
      </div>

      <!-- User Inputs -->
      <div class="space-y-4">
        <div>
          <label
            for="name-input"
            class="block text-sm font-medium text-gray-700 mb-1"
            >1. Your Name</label
          >
          <input
            type="text"
            id="name-input"
            placeholder="Enter your full name"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
          />
        </div>
        <div>
          <label
            for="image-input"
            class="block text-sm font-medium text-gray-700 mb-1"
            >2. Your Photo</label
          >
          <input
            type="file"
            id="image-input"
            accept="image/png, image/jpeg"
            class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
          />
        </div>
      </div>

      <!-- Action Button -->
      <div class="mt-8">
        <button
          id="generate-btn"
          class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-transform transform hover:scale-105"
        >
          Generate Flyer
        </button>
      </div>

      <!-- Error Message -->
      <p
        id="error-message"
        class="text-red-500 text-center mt-4 font-medium hidden"
      ></p>

      <!-- Result Display -->
      <div id="result-container" class="mt-8 text-center hidden">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">
          Your Flyer is Ready!
        </h2>
        <img
          id="result-image"
          class="w-full rounded-lg shadow-md border"
          alt="Generated Flyer"
        />
        <a
          id="download-btn"
          href="#"
          download="my-flyer.png"
          class="mt-6 inline-block w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-transform transform hover:scale-105"
        >
          Download Flyer
        </a>
      </div>

      <!-- Hidden canvas for processing -->
      <canvas id="canvas" style="display: none"></canvas>
    </div>

    <script>
      // --- CONFIGURATION ---
      const flyerTemplateUrl = "https://i.postimg.cc/nc4SpHqW/chgectemp.jpg";

      // --- Placement Settings (X, Y coordinates based on a 1080x1080 template) ---
      // Photo settings
      const photoX = 650; // X-coordinate for the center of the photo (centered)
      const photoY = 450; // Y-coordinate for the center of the photo (moved up)
      const photoRadius = 190; // Radius of the circular photo

      // Name settings
      const nameX = 290; // X-coordinate for the center of the name text (centered)
      const nameY = 495; // Y-coordinate for the baseline of the name text (moved into the box)
      const nameFont = "bold 24px Arial"; // Font changed for reliability
      const nameColor = "#FFFFFF"; // Color of the text (white)
      // ---------------------

      const nameInput = document.getElementById("name-input");
      const imageInput = document.getElementById("image-input");
      const generateBtn = document.getElementById("generate-btn");
      const resultContainer = document.getElementById("result-container");
      const resultImage = document.getElementById("result-image");
      const downloadBtn = document.getElementById("download-btn");
      const errorMessage = document.getElementById("error-message");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      // Helper function to load an image and return a promise
      function loadImage(src, crossOrigin = null) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          if (crossOrigin) {
            img.crossOrigin = crossOrigin;
          }
          img.onload = () => resolve(img);
          img.onerror = (err) =>
            reject(new Error(`Failed to load image: ${src}`));
          img.src = src;
        });
      }

      async function generateFlyer() {
        // 1. Validate inputs
        const name = nameInput.value;
        const imageFile = imageInput.files[0];

        if (!name || !imageFile) {
          errorMessage.textContent =
            "Please provide both your name and a photo.";
          errorMessage.classList.remove("hidden");
          return;
        }
        errorMessage.classList.add("hidden");
        resultContainer.classList.add("hidden");

        // Show loading state
        generateBtn.disabled = true;
        generateBtn.textContent = "Generating...";

        try {
          // 2. Load both images simultaneously and wait for them to be ready
          const userImageSrc = URL.createObjectURL(imageFile);
          const [baseImage, userImage] = await Promise.all([
            loadImage(flyerTemplateUrl, "anonymous"),
            loadImage(userImageSrc),
          ]);

          // 3. Set canvas dimensions to match the template
          canvas.width = baseImage.width;
          canvas.height = baseImage.height;

          // 4. Draw the base flyer template
          ctx.drawImage(baseImage, 0, 0);

          // 5. Draw the user's photo (as a circle)
          ctx.save();
          ctx.beginPath();
          ctx.arc(photoX, photoY, photoRadius, 0, Math.PI * 2, true);
          ctx.closePath();
          ctx.clip();

          const aspectRatio = userImage.width / userImage.height;
          let drawWidth = photoRadius * 2;
          let drawHeight = drawWidth / aspectRatio;

          if (drawHeight < photoRadius * 2) {
            drawHeight = photoRadius * 2;
            drawWidth = drawHeight * aspectRatio;
          }
          const drawX = photoX - drawWidth / 2;
          const drawY = photoY - drawHeight / 2;
          ctx.drawImage(userImage, drawX, drawY, drawWidth, drawHeight);
          ctx.restore();

          // 6. Draw the user's name
          ctx.font = nameFont;
          ctx.fillStyle = nameColor;
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText(name.toUpperCase(), nameX, nameY);

          // 7. Display the result
          const finalImageURL = canvas.toDataURL("image/png");
          resultImage.src = finalImageURL;
          downloadBtn.href = finalImageURL;
          resultContainer.classList.remove("hidden");
        } catch (error) {
          console.error(error);
          errorMessage.textContent =
            "An error occurred. Please check the template link or try a different photo.";
          errorMessage.classList.remove("hidden");
        } finally {
          // Reset button
          generateBtn.disabled = false;
          generateBtn.textContent = "Generate Flyer";
        }
      }

      generateBtn.addEventListener("click", generateFlyer);
    </script>
  </body>
</html>
